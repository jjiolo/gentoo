#!/usr/bin/sh
#############
debug(){ printf "%s\n" "debug - ${1}" ; exit 1 ; }
#############
[ "${USER}" == "root" ] || debug "requires root"
#############
pgrep -x /usr/bin/X &>/dev/null && debug "xorg-server already running"
#############
[ -z "${1}" ] && user="user" || user="${1}"
#############
grep -q "^${user}:" /etc/passwd || debug "user does not exist"
#############
install -d -o desktop -g desktop -m 0755 /run/display
install    -o desktop -g desktop -m 0640 /dev/null /run/display/0.log
install    -o desktop -g desktop -m 0640 /dev/null /run/display/0.log.old
install    -o desktop -g desktop -m 0640 /dev/null /run/display/0.auth
printf "%s\n" "add :0 . $(hexdump -n16 -ve '1/1 "%02x"' /dev/urandom)" | xauth -nqf /run/display/0.auth
chown desktop:"${user}" /run/display/0.auth ; chmod 0640 /run/display/0.auth
#############

su -l -s /usr/bin/sh desktop << EOF
DISPLAY=:0 XAUTHORITY=/run/display/0.auth \
setsid xinit /etc/xinitrc -- /usr/bin/X \
-extension 'Generic Event Extension' \
-extension 'MIT-SHM' \
-extension 'XTEST' \
-extension 'XINERAMA' \
+extension 'XFIXES' \
+extension 'RENDER' \
+extension 'RANDR' \
-extension 'COMPOSITE' \
-extension 'DAMAGE' \
-extension 'DOUBLE-BUFFER' \
-extension 'RECORD' \
-s 0 -auth /run/display/0.auth -logfile /run/display/0.log \
-nolisten tcp -nolisten unix -listen local \
+bs -tst -maxclients 64 \
vt7 </dev/null &>/dev/null :0 & exit
EOF

#############

until [ -f "/tmp/.X0-lock" ] ; do sleep 1 ; done

rm /tmp/.X0-lock ; chmod 0640 /run/display/0.log

#############

su -l -s /usr/bin/sh -c 'DISPLAY=:0 XAUTHORITY=/run/display/0.auth setsid dwm-host </dev/null &>/dev/null & exit' "${user}"

#############

