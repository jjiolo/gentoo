#!/usr/bin/sh
#############
debug(){ printf "%s\n" "pivot: <run_by> <run_as> - ${1}" ; exit 1 ; }
#############
[ "${USER}" == "root" ] || debug "requires root"
#############
[ -z "${1}" ] || [ -z "${2}" ] && debug "no input"
#############
[ -e "/dev/shm/${1}.${2}" ] && debug "socket already exists"
#############

setsid su -l -s /usr/bin/sh -c "dtach -n /dev/shm/${1}.${2} /usr/bin/sh -l" "${2}"

until [ -S "/dev/shm/${1}.${2}" ] ; do sleep 1 ; done

chown "${2}:${1}" "/dev/shm/${1}.${2}"
chmod 0660 "/dev/shm/${1}.${2}"

#############
printf "%s\n" "dtach -a /dev/shm/${1}.${2}"
#############
